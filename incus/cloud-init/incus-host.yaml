#cloud-config
# Incus Host - Creates a container/VM capable of running Incus
#
# Usage:
#   incus launch images:ubuntu/24.04/cloud my-incus-host \
#     -c cloud-init.user-data="$(cat incus/cloud-init/incus-host.yaml)"
#
# After boot:
#   incus exec my-incus-host -- cloud-init status --wait
#   incus exec my-incus-host -- incus list
#
# For YubiKey passthrough (from physical host):
#   incus config device add my-incus-host yubikey usb vendorid=1050

package_update: true

packages:
  - git
  - make
  - curl
  - gpg
  - pcscd        # smart card daemon for YubiKey
  - pcsc-tools   # debugging tools (pcsc_scan)
  - age          # encryption tool

runcmd:
  # Download and verify Zabbly GPG key
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
  - |
    EXPECTED="4EFC590696CB15B87C73A3AD82CC8797C838DCFD"
    ACTUAL=$(gpg --show-keys --fingerprint /etc/apt/keyrings/zabbly.asc 2>/dev/null | grep -oP '[A-F0-9 ]{40,}' | tr -d ' ' | head -1)
    if [ "$ACTUAL" != "$EXPECTED" ]; then
      echo "GPG key fingerprint mismatch! Expected: $EXPECTED, Got: $ACTUAL" >&2
      exit 1
    fi
    echo "GPG key verified: $ACTUAL"
  # Add Zabbly repository
  - |
    . /etc/os-release
    cat > /etc/apt/sources.list.d/zabbly-incus-stable.sources <<EOF
    Enabled: yes
    Types: deb
    URIs: https://pkgs.zabbly.com/incus/stable
    Suites: $VERSION_CODENAME
    Components: main
    Architectures: $(dpkg --print-architecture)
    Signed-By: /etc/apt/keyrings/zabbly.asc
    EOF
  # Install Incus
  - apt-get update
  - apt-get install -y incus incus-ui-canonical
  # Enable web UI
  - incus config set core.https_address :8443
  # Configure polkit for YubiKey/smart card access
  - |
    cat > /etc/polkit-1/rules.d/01-pcscd.rules << "EOF"
    polkit.addRule(function(action, subject) {
        if ((action.id == "org.debian.pcsc-lite.access_pcsc" ||
             action.id == "org.debian.pcsc-lite.access_card") &&
            subject.isInGroup("plugdev")) {
            return polkit.Result.YES;
        }
    });
    EOF
  # Install age-plugin-yubikey
  - |
    ARCH=$(dpkg --print-architecture)
    case "$ARCH" in
      amd64) ARCH="x86_64" ;;
      arm64) ARCH="aarch64" ;;
    esac
    curl -sL "https://github.com/str4d/age-plugin-yubikey/releases/download/v0.5.0/age-plugin-yubikey-v0.5.0-${ARCH}-linux.tar.gz" | \
      tar xz --strip-components=1 -C /usr/local/bin
  # Install passage (shell script, requires make install)
  - |
    git clone https://github.com/FiloSottile/passage /tmp/passage
    cd /tmp/passage && make install PREFIX=/usr/local
    rm -rf /tmp/passage
  # Signal completion
  - echo "Incus host ready" > /root/incus-host-ready

final_message: |
  Incus host ready!

  For YubiKey access, add USB device then restart pcscd:
    incus config device add <container> yubikey usb vendorid=1050
    incus exec <container> -- systemctl restart pcscd
    incus exec <container> -- age-plugin-yubikey --list
